name: codeql

on:
    push:
        branches: [ main, master ]
    pull_request:
        branches: [ main, master ]
    schedule:
        - cron: '0 5 * * 1'   # Mondays 05:00 UTC
    workflow_dispatch:

jobs:
    analyze:
        runs-on: ubuntu-latest
        permissions:
            actions: read
            contents: read
            security-events: write   # required so results show up under "Code scanning alerts"
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Init CodeQL
              uses: github/codeql-action/init@v3
              with:
                  languages: csharp
                  # you can add more langs if you later add JS, etc:
                  # languages: csharp,javascript

            - name: Autobuild
              uses: github/codeql-action/autobuild@v3

            # Run analysis, upload alerts to GitHub Security,
            # AND also save a SARIF locally so we can summarize.
            - name: Analyze
              id: analyze
              uses: github/codeql-action/analyze@v3
              with:
                  output: codeql-results.sarif

            # Upload SARIF as build artifact so you can download it from the run UI
            - name: Upload CodeQL SARIF
              uses: actions/upload-artifact@v4
              with:
                  name: codeql-sarif
                  path: codeql-results.sarif

            # Generate a human-readable summary in the job Summary tab
            - name: Summarise findings
              run: |
                  # Pick the first SARIF file generated by CodeQL (usually only one for C#)
                  SARIF_FILE=$(ls codeql-results.sarif/*.sarif | head -n1)

                  if [ -z "$SARIF_FILE" ]; then
                    echo "No SARIF file found, skipping summary." >> $GITHUB_STEP_SUMMARY
                    exit 0
                  fi

                  # Get total results; if missing/null, treat as 0
                  TOTAL=$(jq '(.runs[0].results // []) | length' "$SARIF_FILE")

                  # Build a "top rules" summary safely.
                  # If there are zero results, this will just be empty.
                  TOP_RULES=$(jq -r '
                    (.runs[0].results // [])
                    | group_by(.ruleId)
                    | sort_by(length) | reverse
                    | .[0:10]
                    | map([.[0].ruleId, (length|tostring)] | @tsv)
                    | .[]
                  ' "$SARIF_FILE")

                  {
                    echo "## CodeQL analysis"
                    echo ""
                    echo "**Total findings:** $TOTAL"
                    echo ""

                    if [ "$TOTAL" = "0" ]; then
                      echo "No potential security/code scanning issues were reported ðŸŽ‰"
                    else
                      echo "Most frequent rule IDs (rule â†’ hits):"
                      echo ""
                      echo '```text'
                      echo "$TOP_RULES"
                      echo '```'
                      echo ""
                      echo "_Full SARIF attached as artifact \`codeql-sarif\` and alerts uploaded to the repository's Security tab._"
                    fi
                  } >> $GITHUB_STEP_SUMMARY
